# Ingress Configuration for Cloudflare Integration
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: archiveofobselis-ingress
  namespace: media-server
  annotations:
    # Traefik ingress controller
    kubernetes.io/ingress.class: "traefik"
    
    # SSL/TLS configuration
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # Security headers for Cloudflare
    traefik.ingress.kubernetes.io/headers:
      custom-request-headers: "X-Forwarded-Proto:https"
      custom-response-headers: |
        X-Frame-Options: DENY
        X-Content-Type-Options: nosniff
        Referrer-Policy: strict-origin-when-cross-origin
        Permissions-Policy: camera=(), microphone=(), geolocation=()
        Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; media-src 'self' https:; connect-src 'self' https://api.archiveofobselis.com https://media.archiveofobselis.com;
    
    # Rate limiting
    traefik.ingress.kubernetes.io/rate-limit: |
      burst: 100
      average: 50
    
    # CORS for media streaming
    traefik.ingress.kubernetes.io/cors-headers: |
      Access-Control-Allow-Origin: https://archiveofobselis.com
      Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
      Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With
      Access-Control-Allow-Credentials: true
      Access-Control-Max-Age: 86400
    
    # Media streaming optimizations
    traefik.ingress.kubernetes.io/buffering:
      maxRequestBodyBytes: "75GB"
      memRequestBodyBytes: "1GB"
      maxResponseBodyBytes: "75GB"
      memResponseBodyBytes: "1GB"
      retryExpression: "IsNetworkError() && Attempts() < 3"

spec:
  tls:
  - hosts:
    - archiveofobselis.com
    - www.archiveofobselis.com
    - api.archiveofobselis.com
    - media.archiveofobselis.com
    secretName: archiveofobselis-tls
  
  rules:
  # Main website
  - host: archiveofobselis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  
  # www subdomain
  - host: www.archiveofobselis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  
  # API endpoints
  - host: api.archiveofobselis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 3001
  
  # Media streaming and uploads
  - host: media.archiveofobselis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 3001 